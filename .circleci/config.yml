version: 2
jobs:
  build:
    working_directory: ~/postgres_dba
    docker:
      - image: circleci/postgres:12
        environment:
          - PGHOST: 127.0.0.1
          - PGUSER: root
    steps:
      - checkout
      - run:
          name: Prepare DB
          command: |
            psql test -c "create table align1 as select 1::int4, 2::int8, 3::int4 as more from generate_series(1, 100000) _(i);"
            psql test -c "create table align2 as select 1::int4, 3::int4 as more, 2::int8 from generate_series(1, 100000) _(i);"
      - run:
          name: Tests
          command: |
            #  echo "\set postgres_dba_wide true" > ~/.psqlrc
            #for f in ~/postgres_dba/sql/*; do psql test -f "$f">/dev/null; done
            #echo "\set postgres_dba_wide false" > ~/.psqlrc
            #for f in ~/postgres_dba/sql/*; do psql test -f "$f">/dev/null; done
            diff -b test/regression/0_node.out <(psql test -f warmup.psql -f ~/postgres_dba/sql/0_node.sql | grep Role)
            diff -b test/regression/p1_alignment_padding.out <(psql test -f warmup.psql -f ~/postgres_dba/sql/p1_alignment_padding.sql | grep align)
            diff -b test/regression/a1_activity.out <(psql test -f warmup.psql -f ~/postgres_dba/sql/a1_activity.sql | grep User)
